<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>DirEngine - Free Bootstrap 4 Template by Colorlib</title>
    <link th:insert="~{fragments/css.html :: css}"></link>
    <link rel="stylesheet" th:href="@{css/booking/booking.css}">

    <style>
        .terms-section {
            margin: 20px;
            font-size: 1.2em;
        }

        .terms-section .expand {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .terms-section .term-content {
            display: none;
            margin: 10px 0;
        }

        .terms-section .term-content p {
            margin: 5px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 70%; /* 팝업 창의 너비를 50%로 줄였습니다. */
            max-width: 600px; /* 최대 너비를 설정하여 큰 화면에서도 적당한 크기로 유지 */
            font-size: 0.9em; /* 글씨 크기를 줄였습니다. */
        }
        .modal-content p {
            margin-bottom: 10px; /* 문단 간 간격 조정 */
            line-height: 1.4; /* 줄 간격을 약간 좁게 설정 */
        }

        .privacy-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .privacy-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 70%;
            max-width: 600px;
            font-size: 0.9em;
        }

        .privacy-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .privacy-close:hover,
        .privacy-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .privacy-modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .privacy-modal-content th, .privacy-modal-content td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .privacy-modal-content th {
            background-color: #f2f2f2;
        }

        .privacy-modal-content td {
            vertical-align: top;
        }

        .notice {
            margin-top: 20px;
            font-size: 0.8em;
            color: #555;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        select#coupon {
            width: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background-color: white;
            color: #333;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        select#coupon:focus {
            border-color: #5cb85c;
            box-shadow: 0 0 5px rgba(92, 184, 92, 0.5);
            outline: none;
        }

        /* 버튼 스타일링 */
        .button-group button {
            padding: 10px 20px;
            background-color: #5cb85c;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .button-group button:hover {
            background-color: #4cae4c;
        }

    </style>

    <!-- jQuery -->
    <script
            type="text/javascript"
            src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

    <!-- iamport.payment.js -->
    <script
            type="text/javascript"
            src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <script>
        var IMP = window.IMP;
        IMP.init("imp67844376");

        function requestPay() {
            IMP.request_pay(
                {
                    pg: "html5_inicis",		//KG이니시스 pg파라미터 값
                    pay_method: "card",		//결제 방법
                    merchant_uid: "1234578",//주문번호
                    name: "당근 10kg",		//상품 명
                    amount: 200,			//금액
                    buyer_email: "gildong@gmail.com",
                    buyer_name: "홍길동",
                    buyer_tel: "010-4242-4242",
                    buyer_addr: "서울특별시 강남구 신사동",
                    buyer_postcode: "01181"

                },
                function (rsp) {
                    if (rsp.success) {
                        // 결제 성공 시 폼을 제출합니다.
                        document.getElementById('terms-form').submit();
                    } else {
                        alert("결제에 실패하였습니다. 에러 내용: " + rsp.error_msg);
                    }
                }
            );
        }
    </script>
</head>


<body style="background-color: #0c5460">

<nav th:insert="~{fragments/navbar.html :: navbar}"></nav>
<!-- END nav -->

<div class="hero-wrap js-fullheight" style="background-image: url('../static/images/bg_4.jpg');">
    <div class=""></div>
    <div class="">
        <div class="row no-gutters slider-text js-fullheight align-items-center justify-content-center" data-scrollax-parent="true">
            <div class="col-md-9 ftco-animate text-center" data-scrollax=" properties: { translateY: '70%' }">
                <p class="breadcrumbs" data-scrollax="properties: { translateY: '30%', opacity: 1.6 }"><span class="mr-2"><a href="index.html">Home</a></span> <span>Blog</span></p>
                <h1 class="mb-3 bread" data-scrollax="properties: { translateY: '30%', opacity: 1.6 }">예약</h1>
            </div>
        </div>
    </div>
</div>
<form id="terms-form">
    <div class="container1">
        <div class="section">
            <h1 th:text="${list.accommodationName}"></h1>
            <h3 th:text="${list.roomName}"></h3>
            <div class="form-group form-inline">
                <label for="check-out"> 일정 </label>
                <input type="text" id="check-out" th:value="${list.roomCheckIn}" style="border: none; display: block;" readonly /><br>
                <input type="text" id="check" th:value="${list.roomCheckOut}" style="border: none;" readonly />
            </div>
            <div class="form-group">
                <label>기준 인원</label>
                <input type="text" th:value="${list.roomPersonnel}" readonly />
                <label>최대 인원</label>
                <input type="text" th:value="${list.roomMaxPersonnel}" readonly />

            </div>
        </div>

        <div class="section">
            <h3>예약자 정보</h3>
            <div class="form-group">
                <input type="text" id="name" th:value="${user.userName}" />
            </div>
            <div class="form-group">
                <input type="text" id="phone" th:value="${user.userPhone}" style="flex: 1;" />
            </div>
        </div>

        <div class="section">
            <label for="coupon">쿠폰</label>
            <div class="button-group">
                <select id="coupon">
                    <option value="" selected>선택안함</option>
                    <option th:each="coupon : ${coupons}"
                            th:value="${coupon.couponId}"
                            th:text="${coupon.couponName}">
                    </option>
                </select>
                <button type="button" onclick="applyCoupon()">적용</button>
            </div>
        </div>
        <div class="terms-section">
            <div class="checkbox-container">
                <input type="checkbox" id="agree-all" onclick="toggleAllCheckboxes(this)">
                <label for="agree-all">약관 전체동의</label>
            </div>
            <div class="terms-container">
                <div class="terms-item">
                    <div class="checkbox-container">
                        <input type="checkbox" id="term1" class="individual-term" onclick="toggleAgreeAll()">
                        <label for="term1">숙소 이용규칙 및 취소/환불규정 동의 (필수)</label>
                        <span class="expand" onclick="openModal('modal1')">&gt;</span>
                    </div>
                    <div id="modal1" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('modal1')">&times;</span>
                            <b>이용규칙 내용</b>
                            <p>최대 인원 초과 시 입실이 불가합니다.</p>
                            <p>정원 기준 요금 외 인원 추가 요금을 포함하여 조식, 침구, 침대 등의 추가 요금은 예약 시 옵션으로 선택하여 선결제하실 수 있습니다.</p>
                            <p>선결제 하지 않거나 예약 시 옵션에 포함되지 않은 추가 비용이 있을 시 이는 현장결제 대상입니다.</p>
                            <p>제공 이미지는 배정된 객실과 다를 수 있습니다.</p>
                            <p>제공 정보는 숙소의 사정에 따라 변경될 수 있습니다.</p>
                            <p>미성년자는 보호자 동반 시 투숙이 가능합니다.</p>
                            <p>반려동물은 숙소 규정에 따라 출입이 제한되오니 숙소별 상세정보를 꼭 확인해 주세요.</p>
                            <p>체크인 시 배정의 경우, 객실과 베드 타입을 보장하지 않습니다.</p>
                            <p>객실 타입에 시간이 별도 기재된 경우, 체크인/아웃 시간이 상이할 수 있습니다.</p>
                            <p>업체 현장에서 객실 컨디션 및 서비스로 인해 발생된 분쟁은 여기어때에서 책임지지 않습니다.</p>

                            <b>취소/환불규정 내용</b>
                            <p>여기어때에서 판매되는 국내 호텔/리조트/펜션/게스트하우스/캠핑/홈앤빌라 상품은 예약/결제 후 10분 이내에는 무료취소 가능합니다. (단, 체크인 시간 경과 시 취소불가)</p>
                            <p>숙소 사정에 의해 취소 발생 시 100% 환불이 가능합니다.</p>
                            <p>예약 상품 환불 및 정보에 기재된 취소, 환불 규정을 반드시 확인 후 이용해주시기 바랍니다.</p>
                            <p>예약/결제 10분 이후의 취소는 업체의 취소/환불 규정에 의거하여 적용됩니다.</p>
                            <p>취소, 변경 불가 상품은 규정상 결제완료 이후에는 취소, 변경이 불가합니다.</p>
                        </div>
                    </div>
                </div>
                <div class="terms-item">
                    <div class="checkbox-container">
                        <input type="checkbox" id="term2" class="individual-term" onclick="toggleAgreeAll()">
                        <label for="term2">개인정보 수집 및 이용 동의 (필수)</label>
                        <span class="expand" onclick="openModal('privacy-modal2')">&gt;</span>
                    </div>
                    <div id="privacy-modal2" class="privacy-modal">
                        <div class="privacy-modal-content">
                            <span class="privacy-close" onclick="closeModal('privacy-modal2')">&times;</span>
                            <h2>개인정보 수집 및 이용 동의</h2>
                            <table class="privacy-table">
                                <tr>
                                    <th class="privacy-th">구분</th>
                                    <th class="privacy-th">수집 목적</th>
                                    <th class="privacy-th">수집 항목</th>
                                    <th class="privacy-th">보유 및 이용기간</th>
                                </tr>
                                <tr>
                                    <td rowspan="4" class="privacy-td">필수</td>
                                    <td class="privacy-td">예약/구매 서비스 제공 상담 및 부가 정거래 기록 확인</td>
                                    <td class="privacy-td">
                                        [예약·구매]<br>
                                        예약자 정보(이름, 휴대전화번호)<br><br>
                                        [결제]<br>
                                        거래내역<br>
                                        *결제 시 개인정보는 PG사(결제대행업체)에서 수집 및 저장하고 있으며, 회사는 PG사에서 제공하는 거래 내역만 제공받음<br><br>
                                        [거래명세서 발급]<br>
                                        이메일주소<br><br>
                                        [현금영수증 발급]<br>
                                        휴대전화번호, 이메일주소<br><br>
                                        [취소·환불]<br>
                                        은행명, 계좌번호, 예금주명
                                    </td>
                                    <td rowspan="4" class="privacy-td">- 회원 탈퇴 시 까지<br>* 관계 법령에 따라 보존할 필요가 있는 경우 해당 법령에서 요구하는 기한까지 보유</td>
                                </tr>
                            </table>
                            <div class="notice">
                                ※ 위 등의 내용을 거부하실 수 있으나, 동의를 거부하실 경우 서비스를 이용하실 수 없습니다.<br>
                                ※ 개인정보 처리와 관련된 상세 내용은 '개인정보처리방침'을 참고
                            </div>
                        </div>
                    </div>
                </div>



                <div class="terms-item">
                    <div class="checkbox-container">
                        <input type="checkbox" id="term4" class="individual-term" onclick="toggleAgreeAll()">
                        <label for="term4">만 14세 이상 확인 (필수)</label>
                        <span class="expand" onclick="openModal('privacy-modal4')">&gt;</span>
                    </div>
                    <div id="privacy-modal4" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('privacy-modal4')">&times;</span>
                            <h2>만 14세 이상 확인 (필수)</h2>
                            <p style="color: red;">여기어때는 <strong>만 14세 미만 아동의 서비스 이용을 제한하고 있습니다.</strong></p>
                            <p>개인정보 보호법에는 만 14세 미만 아동의 개인정보 수집 시 법정대리인 동의를 받도록 규정하고 있으며, <strong>만 14세 미만 아동이 법정대리인 동의없이 서비스 이용이 확인된 경우 서비스 이용이 제한될 수 있음을 알려드립니다.</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="price-info">
            <div>
                객실 가격 ( 1 박 기준 ): <span class="price" id="base-price">30000 원</span>
            </div>
            <div id="discount-amount"></div>
            <hr style="color: black;background-color: black">
            <div>
                총 결제 금액 : <span class="final-price" id="final-price">30000 원</span>
            </div>
        </div>

        <button type="submit" class="pay-button">결제하기</button>
    </div>
</form>


<script>
    function applyCoupon() {
        const couponSelect = document.getElementById('coupon');
        const selectedCouponId = parseInt(couponSelect.options[couponSelect.selectedIndex].value); // couponId를 int로 변환

        // const couponId = document.getElementById("couponId").value;
        console.log("--------" + selectedCouponId)
        if (isNaN(selectedCouponId)) {
            alert("Please select a valid coupon.");
            return;
        }

        // AJAX 요청을 통해 서버로 쿠폰 ID 전송
        $.ajax({
            url: "/apply-coupon",
            method: "POST",
            data:JSON.stringify({ couponId: selectedCouponId }), // couponId를 JSON으로 전송
            contentType: "application/json",
            success: function(response) {
                const discount = response.couponDiscount; // 서버에서 받은 할인 값 (int)
                const discountType = response.couponType; // 서버에서 받은 할인 타입 (예: 'percentage' 또는 'amount')
                const basePrice = parseInt(document.getElementById('base-price').textContent); // 기본 가격을 int로 변환
                console.log("kkkkkk" + basePrice)

                const percent = Math.floor(basePrice * (discount / 100));

                let finalPrice;
                if (discountType === 'DISCOUNT_RATE') {
                    finalPrice = basePrice - percent; // 퍼센트 할인을 정수로 계산
                } else {
                    finalPrice = basePrice - discount; // 금액 할인을 정수로 계산
                }

                document.getElementById('final-price').textContent = finalPrice; // 최종 가격을 정수로 표시

                let discountElement = document.getElementById('discount-amount');
                if (!discountElement) {
                    discountElement = document.createElement('p');
                    discountElement.id = 'discount-amount';
                    document.getElementById('price-section').appendChild(discountElement);
                }
                if (discountType === 'DISCOUNT_RATE') {
                    discountElement.textContent = `할인 가격: ${percent} 원`;
                } else {
                    discountElement.textContent = `할인 가격: ${discount} 원`;
                }
            },
            error: function(error) {
                console.error("Error applying coupon:", error);
                alert("Failed to apply coupon. Please try again.");
            }
        });
    }

    function toggleAllCheckboxes(source) {
        const checkboxes = document.querySelectorAll('.individual-term');
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
    }

    function toggleAgreeAll() {
        const agreeAll = document.getElementById('agree-all');
        const checkboxes = document.querySelectorAll('.individual-term');
        agreeAll.checked = [...checkboxes].every(checkbox => checkbox.checked);
    }

    function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }

    document.getElementById('terms-form').addEventListener('submit', function(event) {

        event.preventDefault();

        const requiredCheckboxes = document.querySelectorAll('.individual-term');
        const allChecked = [...requiredCheckboxes].every(checkbox => checkbox.checked);
        if (!allChecked) {
            alert("필수 항목을 모두 체크해야 제출할 수 있습니다.");
            event.preventDefault();
        } else {
            // 모든 필수 항목이 체크되었을 때 requestPay() 함수를 실행합니다.
            requestPay();
        }
    });

</script>

<div th:insert="~{fragments/footer.html :: footer}"></div>
<!-- loader -->
<div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px"><circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/><circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/></svg></div>

</body>
<div th:insert="~{fragments/js.html :: js}"></div>
</html>